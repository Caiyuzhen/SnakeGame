//æ§åˆ¶å™¨(æ ¸å¿ƒ tsï¼Œç”¨æ¥æ§åˆ¶å…¶ä»–æ‰€æœ‰ç±»ï¼‰â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

import Food from './Food'
import ScorePanel from './ScorePanel'
import Snake from './Snake'


class GameControl {

  //å®šä¹‰è›‡ã€åˆ†æ•°ã€é£Ÿç‰©ä¸‰ä¸ªå±æ€§
  snake:Snake
  food:Food
  scorePanel:ScorePanel
  direction:string=''//å­˜å‚¨è›‡çš„ç§»åŠ¨æ–¹å‘ï¼ˆä¹Ÿå°±æ˜¯ç”¨æˆ·æŒ‰ä¸‹çš„æŒ‰é”®çš„æŒ‰é”®æ–¹å‘)
  isLive:boolean = true //åˆ¤æ–­æ¸¸æˆæ˜¯å¦ç»“æŸ


  constructor(){ //ğŸ”¥ğŸ”¥ğŸ”¥åœ¨åˆå§‹åŒ–çš„æ„é€ å‡½æ•°é‡Œï¼Œå®ä¾‹åŒ–ä¸‰ä¸ªæ¨¡å—ï¼ï¼
    this.snake = new Snake()
    this.food = new Food()
    this.scorePanel = new ScorePanel()

    //ğŸŒŸè®©è›‡ç§»åŠ¨çš„æ–¹æ³•äºŒï¼šåˆå§‹åŒ–æ—¶åå¤è°ƒè‡ªå·±
    // setInterval(()=>{ //åå¤çš„è°ƒç”¨ï¼Œè®©è›‡å»ç§»åŠ¨, æ‰§è¡Œ moveSnake() æ–¹æ³•
    //   this.init()
    // },100)

    //ğŸŒŸè®©è›‡ç§»åŠ¨çš„æ–¹æ³•äºŒï¼šåœ¨å‡½æ•°å†…æ¯éš” X ç§’ï¼Œè‡ªå·±è°ƒè‡ªå·±
    this.init()
  }



  //æ¸¸æˆçš„åˆå§‹åŒ–æ–¹æ³•ï¼Œè°ƒç”¨åå°±ä¼šå¼€å§‹æ¸¸æˆ
  init():void{
    //ğŸ”¥ğŸ”¥ğŸ”¥ç›‘å¬æ–¹å‘ï¼Œ( ä¸€ï¼šè§¦å‘æŒ‰é”®äº‹ä»¶ï¼Œç»‘å®šæŒ‰é”®æ–¹å‘), ç»™æ•´ä¸ª document ç»‘å®šä¸€ä¸ªé”®ç›˜äº‹ä»¶
    document.addEventListener('keydown',this.keydownHandle.bind(this)) //å½“äº‹ä»¶è§¦å‘çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨ keydownHandle å‡½æ•°, æ³¨æ„ this çš„æŒ‡å‘é—®é¢˜, ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥é€šè¿‡ bind() æ–¹æ³•ï¼ŒæŠŠ this çš„æŒ‡å‘æ”¹ä¸º GameControl å¯¹è±¡

    //âš¡ï¸âš¡ï¸âš¡ï¸æ‰§è¡Œ moveSnake() æ–¹æ³•ï¼Œè®©è›‡å¼€å§‹ç§»åŠ¨
    this.moveSnake()
  }



  //ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥é”®ç›˜çš„å‡½æ•°ï¼ˆä¸€ï¼šè·å–æŒ‰é”®çš„æ–¹å‘)
  keydownHandle(event:KeyboardEvent):void { //ğŸŒŸä¼ å…¥é”®ç›˜äº‹ä»¶çš„ API ï¼ï¼

    //éœ€è¦æ£€æŸ¥ä¸€ä¸‹é”®ç›˜æ˜¯å¦åˆæ³•, æ–¹å‘æ˜¯ä¸æ˜¯é”®ç›˜çš„ä¸Šä¸‹å·¦å³

    this.direction = event.key //å­˜å‚¨æŒ‰ä¸‹çš„æ–¹å‘
    console.log(event.key)   //è·å– â¬†ï¸ â¬‡ï¸ â¬…ï¸ â¡ï¸ æŒ‰é”®çš„åå­—: æ‰“å°å‡ºæŒ‰ä¸‹çš„æŒ‰é”®(ArrowLeft\ArrowRight\ArrowUp\ArrowDown)
    // this.moveSnake() //æŒ‰ä¸€æ¬¡æ‰§è¡Œä¸€æ¬¡
  }



  //ç§»åŠ¨è›‡çš„æ–¹æ³•Â·â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  moveSnake():void{
    //æ ¹æ® this.direction æ¥æ”¹å˜è›‡çš„æ–¹å‘
        //å‘ä¸Š top å‡å°‘
        //å‘ä¸‹ bottom å¢åŠ 
        //å‘å·¦ left å‡å°‘
        //å‘å³ right å¢åŠ 

    //ğŸ”¥ğŸ”¥ğŸ”¥è·å–è›‡ç°åœ¨çš„åæ ‡
    let headX = this.snake.headX
    let headY = this.snake.headY

    //ğŸ”¥ğŸ”¥ğŸ”¥è®¡ç®—å€¼ï¼šåˆ¤æ–­ this.direction çš„ 4 ç§ X 2 æƒ…å†µæ¥è®¡ç®—æ”¹å˜çš„å€¼(å› ä¸ºè¦åŒ…å« window æœºï¼Œwindow æœºæ˜¯ Up / Down...)
    switch( this.direction ){
      case "ArrowUp": 
      case "Up": 
        headY -= 10;  //å‘ä¸Šå°±æ˜¯ Y å‡å°, æ¯æ¬¡ç§»åŠ¨ä¸€æ ¼ä¸º 10
        break;
      case "ArrowDown":
      case "Down":
        headY += 10;//å‘ä¸‹å°±æ˜¯ Y å¢åŠ , æ¯æ¬¡ç§»åŠ¨ä¸€æ ¼ä¸º 10
        break;
      case "ArrowLeft":
      case "Left":
        headX -= 10;//å‘å·¦å°±æ˜¯ X å‡å°, æ¯æ¬¡ç§»åŠ¨ä¸€æ ¼ä¸º 10
        break;
      case "ArrowRight":
      case "Right":
        headX += 10;
        //å‘å³å°±æ˜¯ X å¢åŠ , æ¯æ¬¡ç§»åŠ¨ä¸€æ ¼ä¸º 10
        break;
    }


    //åˆ¤æ–­æ˜¯å¦åƒåˆ°äº†é£Ÿç‰©ï¼ŒğŸŒŸæ­¥éª¤äºŒï¼šåˆ™è°ƒç”¨ä¸‹é¢å‡½æ•°çš„è¿”å›å€¼å¹¶ä¼ å…¥æœ€æ–°çš„è›‡å¤´ä½ç½®çš„æ•°æ®ğŸœğŸœ
    this.checkEatFood(headX,headY)


    //ğŸŒŸåˆ¤æ–­å¦‚æœæ’å¢™äº†åˆ™æ¸¸æˆç»“æŸï¼Œtryã€catch é…åˆç»„ä»¶ throw new Error çš„æ–¹å¼å¾ˆå¸¸ç”¨ï¼ï¼ğŸš€ğŸš€
    try{
        //ğŸ”¥ğŸ”¥ğŸ”¥æ ¹æ®ä¸Šé¢è®¡ç®—çš„å€¼æ¥ä¿®æ”¹è›‡çš„åæ ‡
        this.snake.headX = headX
        this.snake.headY = headY
    }catch (e:any){
        alert(e.message);//æ•è·å¼‚å¸¸åå°±è¯´æ˜æ¸¸æˆç»“æŸï¼Œå¼¹å‡ºæç¤ºä¿¡æ¯
        this.isLive = false//å°† isLive è®¾ç½®ä¸º falseï¼Œè®©è›‡ä¸åŠ¨
    }


    //ğŸŒŸğŸŒŸğŸŒŸè®©è›‡ç§»åŠ¨çš„æ–¹æ³•äºŒï¼šåœ¨å‡½æ•°å†…æ¯éš” X ç§’ï¼Œè‡ªå·±è°ƒè‡ªå·±
    this.isLive && setTimeout( //ğŸ”¥ğŸ”¥ğŸ”¥this.isLive && XXX è¡¨ç¤ºå½“æ¡ä»¶ä¸º true æ‰å¼€å¯ï¼Œå¦åˆ™å°±ä¸å¼€å¯ï¼
      this.moveSnake.bind(this)
    ,300 - (this.scorePanel.level - 1 )*30 )//è®°å¾—ç»‘å®šå›è°ƒå‡½æ•°çš„ this æŒ‡å‘, ç„¶åéšç€ç­‰çº§çš„æå‡ï¼Œé€Ÿåº¦å˜å¿«,äºæ˜¯ç”¨æ—¶é—´å·® 300 æ¥ - (this.scorePanel.level - 1 )*30
  }


  //åˆ¤æ–­è›‡æ˜¯å¦åƒåˆ°äº†é£Ÿç‰© (ğŸ”¥ğŸ”¥æ€è·¯ï¼šæ£€æŸ¥è›‡çš„æ–°åæ ‡æ˜¯å¦å’Œé£Ÿç‰©é‡å äº†ğŸœğŸœ)
  checkEatFood(headX:number, headY:number){ 
    if(headX === this.food.x && headY === this.food.y){ //åˆ¤æ–­æ˜¯å¦åƒåˆ°äº†é£Ÿç‰©ï¼ŒğŸŒŸæ­¥éª¤ä¸€ï¼šè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼ˆéƒ½ä¸€æ ·æ‰ä¼šè¿”å›å¸ƒå°”å€¼ trueï¼‰
      console.log('åƒåˆ°é£Ÿç‰©äº†	');
      //é£Ÿç‰©çš„ä½ç½®éœ€è¦é‡ç½®
      this.food.change()
      //å¢åŠ åˆ†æ•°
      this.scorePanel.addScore()
      //å¢åŠ è›‡çš„é•¿åº¦
      this.snake.addBody()
    }
  }
}



export default GameControl
